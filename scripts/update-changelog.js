#!/usr/bin/env node

/**
 * 自动更新 CHANGELOG.md
 * 当版本号更新时，自动在 changelog 顶部添加新版本条目
 */

const fs = require('fs');
const path = require('path');

const packageJsonPath = path.join(__dirname, '..', 'package.json');
const changelogPath = path.join(__dirname, '..', 'CHANGELOG.md');

// 读取 package.json 获取当前版本
const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
const currentVersion = packageJson.version;

// 读取 CHANGELOG.md
let changelog = fs.readFileSync(changelogPath, 'utf8');

// 检查是否已经包含当前版本
const versionPattern = new RegExp(`## \\[${currentVersion.replace(/\./g, '\\.')}\\]`, 'i');
if (versionPattern.test(changelog)) {
  console.log(`✓ CHANGELOG.md 已包含版本 ${currentVersion}`);
  process.exit(0);
}

// 获取当前日期
const today = new Date();
const dateStr = today.toISOString().split('T')[0].replace(/-/g, '-');
const year = today.getFullYear();
const month = String(today.getMonth() + 1).padStart(2, '0');
const day = String(today.getDate()).padStart(2, '0');
const formattedDate = `${year}-${month}-${day}`;

// 创建新版本条目
const newEntry = `## [${currentVersion}](https://github.com/jianger666/cursor-feedback-extension/releases/tag/v${currentVersion}) (${formattedDate})

### Chores

* bump version to ${currentVersion}

`;

// 找到插入位置（在 "This file is automatically generated..." 之后）
const insertPattern = /(This file is automatically generated by \[release-please\]\(https:\/\/github\.com\/googleapis\/release-please\)\.\n\n)/;
if (insertPattern.test(changelog)) {
  changelog = changelog.replace(insertPattern, `$1${newEntry}`);
} else {
  // 如果找不到模式，就在文件开头插入
  changelog = newEntry + changelog;
}

// 写入文件
fs.writeFileSync(changelogPath, changelog, 'utf8');
console.log(`✓ 已自动更新 CHANGELOG.md，添加版本 ${currentVersion}`);